#!/usr/bin/env python3

# This script plots decomposed spectra for r, (u,v), zeta, delta &
# gamma_tilde generated by post/decomp_spec.f90

#=====perform the various imports========
#=======needed by the main code==========
import sys,os,warnings
# Define main hydra tree locations:
uname=os.getlogin()
homedir=os.getenv('HOME')
rootdir=os.path.join(homedir,'hydra','scripts')
moddir=os.path.join(rootdir,'modules')
graphicsdir=os.path.join(rootdir,'graphics')
sys.path.append(moddir)
import numpy as np
import matplotlib as mpl
import matplotlib.pyplot as plt
import matplotlib.colors as clrs
# Set default plot save resolution to a large value:
mpl.rcParams['savefig.dpi'] = 200
# Set label size:
mpl.rcParams['xtick.labelsize'] = 30
mpl.rcParams['ytick.labelsize'] = 30
mpl.rcParams['axes.linewidth'] = 3
import argparse
warnings.simplefilter("ignore",DeprecationWarning)

#========================================
#=====various function definitions=======
#========================================

def running():
  # Main code opening and controlling a plotting window.

  print '   Plot spectra for one of the following fields:'
  print
  print ' (1) r;   (2) (u,v);   (3) zeta;   (4) delta   or (5) gamma_tilde.'
  print

  iopt=int(raw_input(' Choice (default 4): ') or 4)

  hbar=float(raw_input('Value of H used in the 3D simulations (default 0.4)? ') or 0.4)
  kgn=2.0*np.pi/hbar
  xgn=np.log10(kgn)

  # Open input file:
  if iopt == 1:
     in_file=open('rspec.asc','r')
     ylimits=np.array([-15.0,-3.0])
  elif iopt == 2:
     in_file=open('kspec.asc','r')
     ylimits=np.array([-13.0,-1.0])
  elif iopt == 3:
     in_file=open('zspec.asc','r')
     ylimits=np.array([-12.0,0.0])
  elif iopt == 4:
     in_file=open('dspec.asc','r')
     ylimits=np.array([-14.0,-4.0])
  else:
     in_file=open('gspec.asc','r')
     ylimits=np.array([-10.0,-2.0])
    
  # Read the first header line to get kmax:
  first_line=in_file.readline()
  kmax=int(first_line.split()[-1])
  in_file.seek(0)

  nx=kmax
  xmax=np.log10(2.0*float(nx)/3.0)
  dx=0.1
  xmax=dx*(float(int(xmax/dx)+1))
  xlimits=np.array([0.0,xmax])

  # Read in the full data to a 1d array and close input file:
  raw_data = np.fromfile(file=in_file,dtype=float,sep='\n')
  in_file.close()

  # Set the number of frames:
  nframes = int(len(raw_data)/(4*kmax+2))  
  print 'Number of frames found %i' %nframes

  # Shape the data array into a useful shape for plotting:
  frames=range(0,nframes)
  time=[raw_data[i*(4*kmax+2)] for i in frames]
  tim_eles = [i*(4*kmax+2)+j for i in frames for j in range(2)]
  shaped_data = np.delete(raw_data,tim_eles)[0:(4*kmax+2)*nframes].reshape((nframes,kmax,4))
  k=np.zeros((nframes,nx))
  z=np.zeros((nframes,nx))
  d=np.zeros((nframes,nx))
  g=np.zeros((nframes,nx))
  for i in frames:
    k[i,:]=shaped_data[i].transpose()[0][0:nx]
    z[i,:]=shaped_data[i].transpose()[1][0:nx]
    d[i,:]=shaped_data[i].transpose()[2][0:nx]
    g[i,:]=shaped_data[i].transpose()[3][0:nx]
  global ic 
  # Grab the correct sub-array for plotting (ic is the current frame)  
  ic = 0
  # Initiate a plotting window and plot relevant data into it:
  fig = plt.figure(1,figsize=[12.5,12])
  fig.subplots_adjust(left=0.15)
  ax = fig.add_subplot(111)
  if iopt == 1:
     im  = ax.plot(k[ic],z[ic],'b-',lw=3,label='$\\tilde{h}$')
     im2 = ax.plot(k[ic],d[ic],'r-',lw=3,label='$\\tilde{\\rho}_{\\theta}$')
     im3 = ax.plot(k[ic],g[ic],'m-',lw=3,label='${\\rho}^\\prime_{\\theta}$')
  elif iopt == 2:
     im  = ax.plot(k[ic],z[ic],'b-',lw=3,label='$(\\bar{u},\\bar{v})$')
     im2 = ax.plot(k[ic],d[ic],'r-',lw=3,label='$(u,v)$')
     im3 = ax.plot(k[ic],g[ic],'m-',lw=3,label='$(u^\\prime,v^\\prime)$')
  elif iopt == 3:
     im  = ax.plot(k[ic],z[ic],'b-',lw=3,label='$\\bar{\\zeta}$')
     im2 = ax.plot(k[ic],d[ic],'r-',lw=3,label='$\\zeta$')
     im3 = ax.plot(k[ic],g[ic],'m-',lw=3,label='$\\zeta^\\prime$')
  elif iopt == 4:
     im  = ax.plot(k[ic],z[ic],'b-',lw=3,label='$\\bar{\\delta}$')
     im2 = ax.plot(k[ic],d[ic],'r-',lw=3,label='$\\delta$')
     im3 = ax.plot(k[ic],g[ic],'m-',lw=3,label='$\\delta^\\prime$')
  else:
     im  = ax.plot(k[ic],z[ic],'b-',lw=3,label='$\\bar{\\tilde{\\gamma}}$')
     im2 = ax.plot(k[ic],d[ic],'r-',lw=3,label='$\\tilde{\\gamma}$')
     im3 = ax.plot(k[ic],g[ic],'m-',lw=3,label='$\\tilde{\\gamma}^\\prime$')
  # Set plot title, legend and limits of the plot:
  ax.set_title('Spectra at $t =$'+str('%.2f'%time[ic]), fontsize=40)
  ax.set_xlabel('$\log_{10}\,k$', fontsize=40)
  ax.set_ylabel('$\log_{10}\,|\hat{a}|^2$', fontsize=40)
  ax.tick_params(length=10, width=3)
  ax.legend(loc='upper right',prop={'size':30}, shadow=True)
  ax.axvline(xgn,color='k',ls='--',lw=1)
  ax.set_xlim(xlimits)
  ax.set_ylim(ylimits)

  def on_press(event):
    # Routine to deal with re-plotting the window on keypress. 
    # The keys -/= (ie. -/+ without the shift key) cycle through frames 
    # forward and backwards.
    global ic
    if event.key=='=':
      axes=event.canvas.figure.get_axes()[0]
      ic = (ic+1+nframes) % nframes
      xlim=axes.get_xlim()
      ylim=axes.get_ylim()
      # Clear the axes for replot:
      axes.clear()
      # Replot the relevant data:
      if iopt == 1:
        axes.plot(k[ic],z[ic],'b-',lw=3,label='$\\tilde{h}$')
        axes.plot(k[ic],d[ic],'r-',lw=3,label='$\\tilde{\\rho}_{\\theta}$')
        axes.plot(k[ic],g[ic],'m-',lw=3,label='${\\rho}^\\prime_{\\theta}$')
      elif iopt == 2:
        axes.plot(k[ic],z[ic],'b-',lw=3,label='$(\\bar{u},\\bar{v})$')
        axes.plot(k[ic],d[ic],'r-',lw=3,label='$(u,v)$')
        axes.plot(k[ic],g[ic],'m-',lw=3,label='$(u^\\prime,v^\\prime)$')
      elif iopt == 3:
        axes.plot(k[ic],z[ic],'b-',lw=3,label='$\\bar{\\zeta}$')
        axes.plot(k[ic],d[ic],'r-',lw=3,label='$\\zeta$')
        axes.plot(k[ic],g[ic],'m-',lw=3,label='$\\zeta^\\prime$')
      elif iopt == 4:
        axes.plot(k[ic],z[ic],'b-',lw=3,label='$\\bar{\\delta}$')
        axes.plot(k[ic],d[ic],'r-',lw=3,label='$\\delta$')
        axes.plot(k[ic],g[ic],'m-',lw=3,label='$\\delta^\\prime$')
      else:
        axes.plot(k[ic],z[ic],'b-',lw=3,label='$\\bar{\\tilde{\\gamma}}$')
        axes.plot(k[ic],d[ic],'r-',lw=3,label='$\\tilde{\\gamma}$')
        axes.plot(k[ic],g[ic],'m-',lw=3,label='$\\tilde{\\gamma}^\\prime$')
      # Set the title, legend and plot limits:
      axes.set_title('Spectra at $t =$'+str('%.2f'%time[ic]), fontsize=40)
      axes.set_xlabel('$\log_{10}\,k$', fontsize=40)
      axes.set_ylabel('$\log_{10}\,|\hat{a}|^2$', fontsize=40)
      axes.tick_params(length=10, width=3)
      axes.legend(loc='upper right',prop={'size':30}, shadow=True)
      axes.axvline(xgn,color='k',ls='--',lw=1)
      axes.set_xlim(xlim)  
      axes.set_ylim(ylim)
      plt.draw()
    if event.key=='-':
      axes=event.canvas.figure.get_axes()[0]
      ic = (ic-1+nframes) % nframes
      xlim=axes.get_xlim()
      ylim=axes.get_ylim()
      # Clear the axes for replot:
      axes.clear()
      # Replot the relevant data:
      if iopt == 1:
        axes.plot(k[ic],z[ic],'b-',lw=3,label='$\\tilde{h}$')
        axes.plot(k[ic],d[ic],'r-',lw=3,label='$\\tilde{\\rho}_{\\theta}$')
        axes.plot(k[ic],g[ic],'m-',lw=3,label='${\\rho}^\\prime_{\\theta}$')
      elif iopt == 2:
        axes.plot(k[ic],z[ic],'b-',lw=3,label='$(\\bar{u},\\bar{v})$')
        axes.plot(k[ic],d[ic],'r-',lw=3,label='$(u,v)$')
        axes.plot(k[ic],g[ic],'m-',lw=3,label='$(u^\\prime,v^\\prime)$')
      elif iopt == 3:
        axes.plot(k[ic],z[ic],'b-',lw=3,label='$\\bar{\\zeta}$')
        axes.plot(k[ic],d[ic],'r-',lw=3,label='$\\zeta$')
        axes.plot(k[ic],g[ic],'m-',lw=3,label='$\\zeta^\\prime$')
      elif iopt == 4:
        axes.plot(k[ic],z[ic],'b-',lw=3,label='$\\bar{\\delta}$')
        axes.plot(k[ic],d[ic],'r-',lw=3,label='$\\delta$')
        axes.plot(k[ic],g[ic],'m-',lw=3,label='$\\delta^\\prime$')
      else:
        axes.plot(k[ic],z[ic],'b-',lw=3,label='$\\bar{\\tilde{\\gamma}}$')
        axes.plot(k[ic],d[ic],'r-',lw=3,label='$\\tilde{\\gamma}$')
        axes.plot(k[ic],g[ic],'m-',lw=3,label='$\\tilde{\\gamma}^\\prime$')
      # Set the title, legend and plot limits:
      axes.set_title('Spectra at $t =$'+str('%.2f'%time[ic]), fontsize=40)
      axes.set_xlabel('$\log_{10}\,k$', fontsize=40)
      axes.set_ylabel('$\log_{10}\,|\hat{a}|^2$', fontsize=40)
      axes.tick_params(length=10, width=3)
      axes.legend(loc='upper right',prop={'size':30}, shadow=True)
      axes.axvline(xgn,color='k',ls='--',lw=1)
      axes.set_xlim(xlim)  
      axes.set_ylim(ylim)
      # Finally redraw the plot:
      plt.draw()

  # Begin the plot and link keypress events to the above handler:
  cid=fig.canvas.mpl_connect('key_press_event',on_press)
  plt.show()
 

if __name__ == '__main__':
  # Main code to drive the above routines:
  running()
